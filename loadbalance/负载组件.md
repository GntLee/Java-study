# 负载均衡组件

## 1. nginx

* 优点
  * 正规规则比HAProxy更为强大和灵活
  * Nginx可以通过端口检测到服务器内部的故障，如根据服务器处理网页返回的状态码、超时等，并会把返回错误的请求重新提交到另一个节点
  * Nginx安装与配置比较简单，测试方便
  * Nginx对网络稳定性的依赖小，能ping通就能负载
  * 反向代理（内网ip映射到公网）
  * 正向代理（翻墙）
  * 动静分离
* 缺点
  * 适应范围较小，仅能支持http、https、Email协议。
  * 对后端服务器的健康检查，只支持通过端口检测，不支持url来检测
  * 负载度比LVS小
  * 上传文件故障，Nginx会把上传切到另一台服务器重新处理，LVS直接截断

## 2. LVS

* 优点
  * 几乎可以对所有应用做负载均衡，包括http、数据库、在线聊天室等
  * 抗负载能力强
  * 工作在网络4层之上仅作分发之用，没有流量的产生
  * 对内存和cpu资源消耗比较低
  * 有完整的双机热备方案，如LVS+Keepalived
* 缺点
  * 不支持正则表达式
  * 不能做动静分离
  * 网站应用比较庞大的话，LVS/DR+Keepalived实施复杂
  * LVS/DR+Keepalived（最多）

## 3. HAProxy

* 优点

  * HAProxy支持虚拟主机，可工作在4、7层(支持多网段)

  * HAProxy的优点能够补充Nginx的一些缺点，比如支持Session的保持，Cookie的引导；同时支持通过获取指定的url来检测后端服务器的状态

  * HAProxy跟LVS类似，本身就只是一款负载均衡软件

  * 效率HAProxy比Nginx出色

  * HAProxy支持TCP协议的负载均衡转发，可以对MySQL读进行负载均衡，对后端的MySQL节点进行检测和负载均衡，可以用LVS+Keepalived对MySQL主从做负载均衡

  * HAProxy负载均衡策略多

    * `roundrobin` 轮询,最大支持4095个后端主机

    * 2. `leastconn` 连接数最少的服务器优先接收，建议用于长会话服务，例如LDAP、SQL、TSE等，不适合短会话协议。如HTTP.该算法是动态的，对于实例启动慢的服务器权重会在运行中调整

    * 3. `static-rr` 根据权重轮流使用，类似roundrobin，但它是静态的，意味着运行时修改权限是无效的，`一般不用`

    * 4. `source` 

      > 对请求源IP地址进行哈希，用可用服务器的权重总数除以哈希值，根据结果进行分配。只要服务器正常，同一个客户端IP地址总是访问同一个服务器。如果哈希的结果随可用服务器数量而变化，那么客户端会定向到不同的服务器；该算法一般用于不能插入cookie的Tcp模式。它还可以用于广域网上为拒绝使用会话cookie的客户端提供最有效的粘连；该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。

    * 5. `uri`

      > 根据请求的URI左端（问号之前）进行哈希，用可用服务器的权重总数除以哈希值，根据结果进行分配。只要服务器正常，同一个URI地址总是访问同一个服务器。一般用于代理缓存和反病毒代理，以最大限度的提高缓存的命中率。该算法只能用于HTTP后端；该算法一般用于后端是缓存服务器；该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。

    * 6. `url_param` 

      > 在HTTP GET请求的查询串中查找<param>中指定的URL参数，基本上可以锁定使用特制的URL到特定的负载均衡器节点的要求；该算法一般用于将同一个用户的信息发送到同一个后端服务器；该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。

    * 7. `hdr(name)`

      > 在每个HTTP请求中查找HTTP头<name>，HTTP头<name>将被看作在每个HTTP请求，并针对特定的节点；如果缺少头或者头没有任何值，则用roundrobin代替；该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。

    * 8. `rdp-cookie（name）`

      > 为每个进来的TCP请求查询并哈希RDP cookie<name>；该机制用于退化的持久模式，可以使同一个用户或者同一个会话ID总是发送给同一台服务器。如果没有cookie，则使用roundrobin算法代替；该算法默认是静态的，所以运行时修改服务器的权重是无效的，但是算法会根据“hash-type”的变化做调整。

* 缺点

  * 不支持POP/SMTP协议
  * 不支持SPDY协议
  * 不支持HTTP cache功能。现在不少开源的lb项目，都或多或少具备HTTP cache功能
  * 重载配置的功能需要重启进程，虽是soft restart，但没有Nginx的reaload更为平滑和友好
  * 多进程模式支持不够好



> 常用Nginx/HAProxy+Keepalived负载



# 分阶段解决方案

* `第一阶段`：利用Nginx或者HAProxy进行单点的负载均衡，这一阶段服务器规模刚脱离开单服务器、单数据库的模式，需要一定的负载均衡，但是 仍然规模较小没有专业的维护团队来进行维护，也没有需要进行大规模的网站部署。这样利用Nginx或者HAproxy就是第一选择，此时这些东西上手快， 配置容易，在七层之上利用HTTP协议就可以。这时是第一选择

* `第二阶段`：随着网络服务进一步扩大，这时单点的Nginx已经不能满足，这时使用LVS或者商用F5就是首要选择，Nginx此时就作为LVS或者 F5的节点来使用，具体LVS或者F5的是选择是根据公司规模，人才以及资金能力来选择的，这里也不做详谈，但是一般来说这阶段相关人才跟不上业务的提 升，所以购买商业负载均衡已经成为了必经之路。

* `第三阶段`：这时网络服务已经成为主流产品，此时随着公司知名度也进一步扩展，相关人才的能力以及数量也随之提升，这时无论从开发适合自身产品的定制，以及降低成本来讲开源的LVS，已经成为首选，这时LVS会成为主流。
  最终形成比较理想的状态为：`F5/LVS<—>Haproxy<—>Squid/Varnish<—>AppServer`。



# 其他组件

* Rancher
* Traefik(nginx)
* dnsmasq
* ab
* chproxy(clickhouse负载)
* slb
* lifekeep



# Nginx+Keepalive高可用

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210222205307767.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxMzI5MzM0MzI=,size_16,color_FFFFFF,t_70)